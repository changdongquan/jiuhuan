# ============================================
# ç®€å•ä¿®å¤å‘½ä»¤ - åœ¨æœåŠ¡å™¨ç»ˆç«¯é€è¡Œæ‰§è¡Œ
# ============================================

# ç¬¬1æ­¥ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€
pwd
ls -la

# ç¬¬2æ­¥ï¼šè¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/jh-craftsys/source/backend

# ç¬¬3æ­¥ï¼šç¡®è®¤åœ¨æ­£ç¡®ç›®å½•
pwd

# ç¬¬4æ­¥ï¼šåˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼ˆä½¿ç”¨ tee å‘½ä»¤ï¼Œæ›´å¯é ï¼‰
cat << 'EOF' | tee jiuhuan-backend.service
[Unit]
Description=ä¹…ç¯åç«¯APIæœåŠ¡
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/jh-craftsys/source/backend
Environment=NODE_ENV=production
Environment=PORT=3001
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# ç¬¬5æ­¥ï¼šåˆ›å»ºé…ç½®è„šæœ¬
cat << 'EOFSCRIPT' | tee setup-systemd.sh
#!/bin/bash
set -e
PROJECT_DIR="/opt/jh-craftsys/source/backend"
SERVICE_NAME="jiuhuan-backend.service"
SYSTEMD_DIR="/etc/systemd/system"

if [ "$EUID" -ne 0 ]; then 
    echo "âŒ è¯·ä½¿ç”¨ sudo è¿è¡Œ: sudo bash setup-systemd.sh"
    exit 1
fi

echo "ğŸ“ æ£€æŸ¥é¡¹ç›®ç›®å½•..."
if [ ! -d "$PROJECT_DIR" ]; then
    echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
    exit 1
fi

echo "ğŸ” æ£€æŸ¥ Node.js..."
NODE_PATH=$(which node)
if [ -z "$NODE_PATH" ]; then
    echo "âŒ æœªæ‰¾åˆ° Node.js"
    exit 1
fi
echo "âœ… Node.js: $NODE_PATH"

echo "ğŸ“„ æ£€æŸ¥æœåŠ¡æ–‡ä»¶..."
SERVICE_FILE="$PROJECT_DIR/$SERVICE_NAME"
if [ ! -f "$SERVICE_FILE" ]; then
    echo "âŒ æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨: $SERVICE_FILE"
    exit 1
fi

echo "âš™ï¸  æ›´æ–°æœåŠ¡æ–‡ä»¶..."
sed -i "s|ExecStart=.*node|ExecStart=$NODE_PATH|g" "$SERVICE_FILE"

echo "ğŸ“‹ å¤åˆ¶æœåŠ¡æ–‡ä»¶..."
cp "$SERVICE_FILE" "$SYSTEMD_DIR/$SERVICE_NAME"

echo "ğŸ”„ é‡æ–°åŠ è½½ systemd..."
systemctl daemon-reload

echo "ğŸ”Œ å¯ç”¨æœåŠ¡..."
systemctl enable "$SERVICE_NAME"

echo "ğŸ›‘ å¯åŠ¨æœåŠ¡..."
if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
    systemctl stop "$SERVICE_NAME"
fi
systemctl start "$SERVICE_NAME"
sleep 2

if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
    systemctl status "$SERVICE_NAME" --no-pager -l
else
    echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
    journalctl -u "$SERVICE_NAME" -n 20 --no-pager
    exit 1
fi

echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡..."
ENV_VARS=$(systemctl show "$SERVICE_NAME" | grep "^Environment=")
echo "$ENV_VARS"

if echo "$ENV_VARS" | grep -q "NODE_ENV=production"; then
    echo "âœ… NODE_ENV=production å·²è®¾ç½®"
fi

echo ""
echo "=========================================="
echo "âœ… é…ç½®å®Œæˆï¼"
echo "=========================================="
EOFSCRIPT

# ç¬¬6æ­¥ï¼šè®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
chmod +x setup-systemd.sh

# ç¬¬7æ­¥ï¼šéªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸ
echo ""
echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
ls -lh jiuhuan-backend.service setup-systemd.sh

echo ""
echo "=========================================="
echo "âœ… æ–‡ä»¶åˆ›å»ºå®Œæˆï¼"
echo ""
echo "ä¸‹ä¸€æ­¥æ‰§è¡Œï¼ˆéœ€è¦ sudoï¼‰ï¼š"
echo "  sudo bash setup-systemd.sh"
echo ""
echo "æ³¨æ„ï¼šä¸è¦ç›´æ¥æ‰§è¡Œ .service æ–‡ä»¶"
echo "      ä½¿ç”¨ 'bash setup-systemd.sh' æˆ– 'sudo bash setup-systemd.sh'"
echo ""

