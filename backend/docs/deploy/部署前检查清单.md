# 部署前检查清单

## ✅ 代码完整性检查

### 前端代码

- [x] 构建脚本已配置（`build:pro`）
- [x] SSO 支持代码已添加（`withCredentials: true`）
- [x] 自动登录逻辑已实现（`src/permission.ts`）
- [x] 错误处理已优化（静默处理 SSO 失败）
- [x] 依赖配置完整（`package.json`）

### 后端代码

- [x] 服务器入口文件存在（`server.js`）
- [x] 自动登录接口已实现（`/api/auth/auto-login`）
- [x] 手动登录接口已实现（支持普通账号和域用户）
- [x] 数据库配置已存在（`config.js`）
- [x] 依赖配置完整（`backend/package.json`）
- [x] 健康检查接口已实现（`/health`）

### SSO 相关代码

- [x] 前端 `autoLoginApi` 已添加 `withCredentials: true`
- [x] 后端自动登录接口已实现
- [x] 错误处理已优化（区分 SSO 失败和真实错误）

---

## ⚠️ 需要配置的内容

### 1. 数据库配置

**位置**：`backend/config.js`

**当前状态**：有硬编码的配置，建议使用环境变量

**需要配置**：

```javascript
// 方式1：直接在 config.js 中修改（当前已有）
server: process.env.DB_SERVER || 'jiuhuan.net',
port: parseInt(process.env.DB_PORT) || 3001,
user: process.env.DB_USERNAME || 'sa',
password: process.env.DB_PASSWORD || 'Chang902',
database: process.env.DB_DATABASE || 'jiuhuanDB',

// 方式2：使用环境变量（推荐）
// 在服务器上设置环境变量或创建 .env 文件
```

**检查方法**：

```bash
# 检查后端能否连接数据库
cd backend
node test-db-connection.js
```

### 2. 环境变量配置（可选但推荐）

**前端环境变量**（如果需要）：

创建 `.env.pro` 文件（生产环境）：

```env
VITE_API_BASE_PATH=http://your-server/api
VITE_BASE_PATH=/
VITE_APP_TITLE=九环系统
VITE_USE_MOCK=false
VITE_DROP_CONSOLE=true
VITE_DROP_DEBUGGER=true
```

**后端环境变量**（可选）：

创建 `backend/.env` 文件：

```env
NODE_ENV=production
PORT=3001
DB_SERVER=jiuhuan.net
DB_PORT=3001
DB_USERNAME=sa
DB_PASSWORD=your_password
DB_DATABASE=jiuhuanDB
LDAP_URL=ldap://ad.yourdomain.com:389
LDAP_BASE_DN=DC=yourdomain,DC=com
```

### 3. LDAP 配置（如果使用域用户手动登录）

**位置**：`backend/routes/auth.js`

**当前状态**：使用环境变量，有默认值

**需要配置**（如果需要）：

- `LDAP_URL`：LDAP 服务器地址
- `LDAP_BASE_DN`：LDAP 基础 DN
- `LDAP_BIND_DN`：服务账号（可选）
- `LDAP_BIND_PASSWORD`：服务账号密码（可选）

---

## 📋 部署前验证步骤

### 步骤 1：本地验证代码完整性

```bash
# 1. 检查前端代码
pnpm run build:pro
# 应该成功构建，生成 packages/frontend/dist 目录

# 2. 检查后端依赖
cd backend
npm install
# 应该成功安装所有依赖

# 3. 检查后端代码语法
node -c server.js
# 应该没有语法错误
```

### 步骤 2：验证数据库连接

```bash
cd backend
node test-db-connection.js
# 应该能成功连接数据库
```

### 步骤 3：验证后端服务启动

```bash
cd backend
npm start
# 应该能成功启动，监听 3001 端口
# 访问 http://localhost:3001/health 应该返回成功
```

---

## 🚀 部署准备清单

### 服务器要求

- [ ] Node.js >= 18.0.0（前端构建需要）
- [ ] Node.js >= 14.0.0（后端运行需要）
- [ ] npm 或 pnpm（前端构建）
- [ ] SQL Server 数据库可访问
- [ ] 端口 3001 可用（后端服务）
- [ ] 端口 80/443 可用（Web 服务器）

### 文件准备

- [ ] 前端构建产物（`packages/frontend/dist` 目录）
- [ ] 后端代码（`backend` 目录）
- [ ] 数据库配置已确认
- [ ] 环境变量已配置（如果需要）

### 代码版本

- [x] SSO 相关代码已合并
- [x] 前端 `withCredentials` 已添加
- [x] 后端自动登录接口已实现
- [x] 错误处理已优化

---

## ✅ 结论

**当前代码状态**：✅ **满足部署条件**

### 可以立即部署的内容：

1. ✅ **前端代码**：已完成 SSO 支持，可以构建和部署
2. ✅ **后端代码**：已完成 SSO 支持，可以部署
3. ✅ **SSO 功能**：代码已就绪，等待服务器配置

### 部署后需要配置的内容：

1. ⚠️ **数据库连接**：确保 `backend/config.js` 中的数据库配置正确
2. ⚠️ **环境变量**（可选）：建议使用环境变量管理敏感信息
3. ⚠️ **SSO 服务器配置**：按照 `SSO_配置指南_完整版.md` 配置 Apache + Kerberos

---

## 📝 部署建议

### 推荐部署顺序：

1. **第一步**：部署代码到服务器
   - 部署后端代码
   - 部署前端构建产物
   - 配置简单的 Web 服务器（不启用 Kerberos）
   - 验证基础功能（手动登录）

2. **第二步**：配置 SSO
   - 按照 `SSO_配置指南_完整版.md` 配置
   - 测试 SSO 自动登录

### 快速验证命令：

```bash
# 1. 构建前端
npm run build:pro

# 2. 检查后端
cd backend
npm install
npm start

# 3. 测试健康检查
curl http://localhost:3001/health

# 4. 测试自动登录接口（开发环境返回模拟数据）
curl http://localhost:3001/api/auth/auto-login
```

---

## 🎯 下一步操作

1. **立即可以做的**：
   - 构建前端代码
   - 部署到服务器
   - 测试基础功能

2. **部署后需要做的**：
   - 配置数据库连接
   - 配置 SSO（Apache + Kerberos）

代码已就绪，可以开始部署！🚀
