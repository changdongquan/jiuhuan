# 权限管理系统实施说明

## 实施进度

### ✅ 已完成

1. **数据库表创建**
   - `permissions` - 权限表（存储所有页面）
   - `user_permissions` - 用户权限表
   - `group_permissions` - 组权限表
   - 位置：`packages/backend/scripts/create-permission-tables.sql`

2. **权限同步脚本**
   - 从路由配置同步到数据库
   - 位置：`packages/backend/scripts/sync-routes-to-permissions.js`

3. **权限管理 API**
   - 获取权限列表
   - 获取用户/组权限
   - 分配/移除权限
   - 位置：`packages/backend/routes/permission.js`

4. **登录接口权限查询**
   - 登录时自动查询用户权限
   - 返回权限列表给前端
   - 位置：`packages/backend/routes/auth.js`

5. **前端路由守卫**
   - 添加权限验证逻辑
   - 无权限跳转 403 页面
   - 位置：`packages/frontend/src/permission.ts`

6. **403 页面**
   - 无权限访问提示页面
   - 位置：`packages/frontend/src/views/Error/403.vue`（已存在）

---

## 使用步骤

### 第一步：创建数据库表

在 SQL Server 中执行：

```bash
# 在服务器上执行
sqlcmd -S localhost -d jiuhuanDB -i /opt/jh-craftsys/source/packages/backend/scripts/create-permission-tables.sql
```

或使用 SQL Server Management Studio 执行 `create-permission-tables.sql`

### 第二步：同步路由到权限表

方法一：使用 API（推荐）

```bash
curl -X POST http://localhost:3001/api/permission/sync-routes
```

方法二：使用脚本

```bash
cd /opt/jh-craftsys/source/packages/backend
node scripts/sync-routes-to-permissions.js
```

### 第三步：分配权限

#### 分配用户权限

```bash
POST /api/permission/user/:username/assign
Body: {
  "permissionIds": [1, 2, 3]  // 权限ID数组
}
```

#### 分配组权限

```bash
POST /api/permission/group/:groupName/assign
Body: {
  "permissionIds": [1, 2, 3],
  "groupDn": "CN=模具组,OU=模具,DC=JIUHUAN,DC=LOCAL"
}
```

---

## API 接口说明

### 权限管理 API

| 接口                                      | 方法   | 说明             |
| ----------------------------------------- | ------ | ---------------- |
| `/api/permission/list`                    | GET    | 获取所有权限列表 |
| `/api/permission/user/:username`          | GET    | 获取用户权限     |
| `/api/permission/group/:groupName`        | GET    | 获取组权限       |
| `/api/permission/user/:username/assign`   | POST   | 分配用户权限     |
| `/api/permission/user/:username/remove`   | DELETE | 移除用户权限     |
| `/api/permission/group/:groupName/assign` | POST   | 分配组权限       |
| `/api/permission/group/:groupName/remove` | DELETE | 移除组权限       |
| `/api/permission/sync-routes`             | POST   | 同步路由到权限表 |

---

## 权限验证逻辑

### 用户权限计算

```
用户最终权限 = 用户直接分配的权限 + 用户所属组分配的权限
```

### admin 特殊处理

- `admin` 账号自动拥有所有权限
- 不需要在权限表中分配
- 代码中硬编码判断

### 权限验证流程

1. 用户登录 → 后端查询权限 → 返回权限列表
2. 前端存储权限到 `userStore`
3. 路由跳转 → 路由守卫检查权限
4. 有权限 → 允许访问
5. 无权限 → 跳转 403 页面

---

## 待完成功能

### ⏳ 待实施

1. **AD 数据查询 API**
   - 查询"模具"OU 下的用户列表
   - 查询"模具"OU 下的组列表
   - 查询用户所属组
   - 位置：`packages/backend/routes/ad.js`（待创建）

2. **组权限查询完善**
   - 当前只查询用户直接权限
   - 需要添加组权限查询逻辑
   - 位置：`packages/backend/routes/auth.js` 和 `packages/backend/routes/permission.js`

3. **权限管理前端页面**
   - 权限分配界面
   - 用户/组选择器
   - 权限树形选择器
   - 位置：`packages/frontend/src/views/Authorization/Permission/`（待创建）

---

## 注意事项

1. **权限同步**
   - 新增路由后需要手动同步到权限表
   - 使用 `/api/permission/sync-routes` 接口

2. **权限变更生效**
   - 权限变更后需要用户重新登录才能生效
   - 后续可改为权限刷新机制

3. **默认权限**
   - 新用户默认无权限
   - 必须手动分配权限才能访问页面

4. **admin 账号**
   - admin 自动拥有所有权限
   - 不需要在权限表中分配

---

## 测试建议

### 测试场景

1. **admin 登录测试**
   - admin 应该可以访问所有页面
   - 不需要分配权限

2. **普通用户登录测试**
   - 无权限用户应该无法访问页面
   - 跳转到 403 页面

3. **权限分配测试**
   - 分配权限后，用户应该可以访问对应页面
   - 移除权限后，用户应该无法访问

4. **组权限测试**
   - 组权限应该被组成员继承（待实现）

---

## 文件清单

### 后端文件

- `packages/backend/scripts/create-permission-tables.sql` - 数据库表创建脚本
- `packages/backend/scripts/sync-routes-to-permissions.js` - 权限同步脚本
- `packages/backend/routes/permission.js` - 权限管理 API
- `packages/backend/routes/auth.js` - 登录接口（已修改，添加权限查询）
- `packages/backend/server.js` - 服务器配置（已修改，添加权限路由）

### 前端文件

- `packages/frontend/src/permission.ts` - 路由守卫（已修改，添加权限验证）
- `packages/frontend/src/router/index.ts` - 路由配置（已修改，添加 403 路由）
- `packages/frontend/src/views/Error/403.vue` - 403 页面（已存在）

---

## 下一步计划

1. 实现 AD 数据查询 API
2. 完善组权限查询逻辑
3. 开发权限管理前端页面
4. 实现权限刷新机制（无需重新登录）
5. 添加权限使用日志
