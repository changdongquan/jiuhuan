# 权限系统部署步骤

## 第一步：在服务器上创建数据库表

### 方法一：使用 SQL Server Management Studio（推荐）

1. 连接到 SQL Server（数据库：`jiuhuanDB`）
2. 打开文件：`packages/backend/scripts/create-permission-tables.sql`
3. 执行脚本
4. 确认三张表创建成功：
   - `permissions`
   - `user_permissions`
   - `group_permissions`

### 方法二：使用命令行

```bash
# 在服务器上执行
sshpass -p 'Chang902' ssh -o StrictHostKeyChecking=no -p 222 changyun@jiuhuan.net

# 执行 SQL 脚本
sqlcmd -S localhost -d jiuhuanDB -U sa -P Chang902 -i /opt/jh-craftsys/source/packages/backend/scripts/create-permission-tables.sql
```

### 方法三：使用代码执行（Node.js 脚本）

```bash
# 在服务器上执行
cd /opt/jh-craftsys/source/packages/backend
node -e "
const sql = require('mssql');
const fs = require('fs');
const config = require('./config');

(async () => {
  try {
    await sql.connect(config);
    const script = fs.readFileSync('./scripts/create-permission-tables.sql', 'utf8');
    await sql.query(script);
    console.log('数据库表创建成功');
    process.exit(0);
  } catch (err) {
    console.error('创建失败:', err);
    process.exit(1);
  }
})();
"
```

---

## 第二步：同步路由到权限表

### 方法一：使用 API（推荐，需先部署代码）

```bash
# 在服务器上执行
curl -X POST http://localhost:3001/api/permission/sync-routes
```

### 方法二：使用脚本

```bash
# 在服务器上执行
cd /opt/jh-craftsys/source/packages/backend
node scripts/sync-routes-to-permissions.js
```

---

## 第三步：部署代码到服务器

### 1. 提交并推送代码

```bash
# 在本机执行
git add .
git commit -m "feat: 实现页面级权限管理系统"
git push gitee main
```

### 2. 服务器拉取并重启

```bash
# 在服务器上执行
cd /opt/jh-craftsys/source
git pull gitee main

# 重启后端服务
sudo systemctl restart jiuhuan-backend.service

# 查看服务状态
sudo systemctl status jiuhuan-backend.service
```

---

## 第四步：验证部署

### 1. 检查数据库表

```sql
-- 在 SQL Server 中执行
SELECT COUNT(*) FROM permissions;
SELECT COUNT(*) FROM user_permissions;
SELECT COUNT(*) FROM group_permissions;
```

### 2. 检查 API 接口

```bash
# 获取权限列表
curl http://localhost:3001/api/permission/list

# 获取用户权限（admin）
curl http://localhost:3001/api/permission/user/admin
```

### 3. 测试登录

- admin 登录：应该可以访问所有页面
- 普通用户登录：无权限时应该跳转 403

---

## 第五步：分配权限（测试）

### 1. 查看所有权限

```bash
curl http://localhost:3001/api/permission/list
```

### 2. 给用户分配权限

```bash
# 给 changdq 分配销售订单和项目管理权限
# 需要先获取权限ID（从权限列表接口获取）

curl -X POST http://localhost:3001/api/permission/user/changdq/assign \
  -H "Content-Type: application/json" \
  -d '{
    "permissionIds": [1, 2]
  }'
```

### 3. 验证权限

- 用户 changdq 登录
- 应该可以访问分配的页面
- 未分配的页面应该跳转 403

---

## 注意事项

1. **执行顺序**：
   - 先创建数据库表
   - 再同步路由
   - 最后部署代码

2. **权限同步**：
   - 如果路由配置有变化，需要重新同步
   - 使用 `/api/permission/sync-routes` 接口

3. **admin 账号**：
   - admin 自动拥有所有权限
   - 不需要手动分配

4. **默认权限**：
   - 新用户默认无权限
   - 必须手动分配才能访问页面
