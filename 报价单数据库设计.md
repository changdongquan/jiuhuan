# 报价单数据库设计文档（单表设计）

## 表：报价单表

### 表名

`报价单`

### 字段列表

| 字段名 | 数据类型 | 长度 | 是否可空 | 主键 | 说明 | 备注 |
| --- | --- | --- | --- | --- | --- | --- |
| 报价单ID | INT | - | 否 | 是 | 主键，自增 | 自增主键 |
| 报价单号 | NVARCHAR | 50 | 否 | 否 | 报价单编号，格式：BJ-YYYYMMDD-XXX | 唯一索引 |
| 报价日期 | DATE | - | 否 | 否 | 报价日期 | - |
| 客户名称 | NVARCHAR | 200 | 否 | 否 | 客户名称 | - |
| 加工周期 | DATE | - | 否 | 否 | 加工日期 | - |
| 更改通知单号 | NVARCHAR | 50 | 是 | 否 | 更改通知单号 | - |
| 加工零件名称 | NVARCHAR | 200 | 否 | 否 | 加工零件名称 | - |
| 模具编号 | NVARCHAR | 100 | 否 | 否 | 模具编号 | - |
| 申请更改部门 | NVARCHAR | 100 | 否 | 否 | 申请更改部门 | - |
| 申请更改人 | NVARCHAR | 50 | 否 | 否 | 申请更改人 | - |
| 材料明细 | NVARCHAR(MAX) | - | 否 | 否 | 材料明细JSON数组 | JSON格式存储材料明细数组 |
| 加工费用明细 | NVARCHAR(MAX) | - | 否 | 否 | 加工费用明细JSON数组 | JSON格式存储加工费用明细数组 |
| 其他费用 | DECIMAL | 18,2 | 否 | 否 | 其他费用（焊、合模机、试模等），含税 | 默认值：0 |
| 运输费用 | DECIMAL | 18,2 | 否 | 否 | 合计来回运输费用 | 默认值：0 |
| 加工数量 | INT | - | 否 | 否 | 加工数量 | 默认值：1 |
| 含税价格 | DECIMAL | 18,2 | 否 | 否 | 含税价格（计算字段：材料费+加工费+其他费用+运输费用） | 可存储计算结果 |
| 创建时间 | DATETIME | - | 否 | 否 | 创建时间 | 默认值：GETDATE() |
| 更新时间 | DATETIME | - | 否 | 否 | 更新时间 | 默认值：GETDATE() |

### 索引

- 主键：`报价单ID`
- 唯一索引：`报价单号`
- 普通索引：`报价日期`、`客户名称`、`加工周期`

---

## SQL Server 建表语句

```sql
-- 创建报价单表（单表设计）
CREATE TABLE 报价单 (
    报价单ID INT IDENTITY(1,1) PRIMARY KEY,
    报价单号 NVARCHAR(50) NOT NULL UNIQUE,
    报价日期 DATE NOT NULL,
    客户名称 NVARCHAR(200) NOT NULL,
    加工周期 DATE NOT NULL,
    更改通知单号 NVARCHAR(50) NULL,
    加工零件名称 NVARCHAR(200) NOT NULL,
    模具编号 NVARCHAR(100) NOT NULL,
    申请更改部门 NVARCHAR(100) NOT NULL,
    申请更改人 NVARCHAR(50) NOT NULL,
    材料明细 NVARCHAR(MAX) NOT NULL,
    加工费用明细 NVARCHAR(MAX) NOT NULL,
    其他费用 DECIMAL(18,2) NOT NULL DEFAULT 0,
    运输费用 DECIMAL(18,2) NOT NULL DEFAULT 0,
    加工数量 INT NOT NULL DEFAULT 1,
    含税价格 DECIMAL(18,2) NOT NULL DEFAULT 0,
    创建时间 DATETIME NOT NULL DEFAULT GETDATE(),
    更新时间 DATETIME NOT NULL DEFAULT GETDATE()
);

-- 创建索引
CREATE INDEX IX_报价单_报价日期 ON 报价单(报价日期);
CREATE INDEX IX_报价单_客户名称 ON 报价单(客户名称);
CREATE INDEX IX_报价单_加工周期 ON 报价单(加工周期);
```

---

## JSON 字段格式说明

### 材料明细（材料明细字段）

存储格式：JSON数组字符串

```json
[
  {
    "name": "紫铜电极",
    "unitPrice": 100.0,
    "quantity": 2
  },
  {
    "name": "配件",
    "unitPrice": 50.0,
    "quantity": 1
  }
]
```

**字段说明**：

- `name` (string): 材料名称
- `unitPrice` (number): 单价，保留2位小数
- `quantity` (number): 用量，整数

**计算字段**：

- `费用` = `unitPrice × quantity`（可在前端或后端计算）

---

### 加工费用明细（加工费用明细字段）

存储格式：JSON数组字符串

```json
[
  {
    "key": "nc",
    "name": "数控",
    "unitPriceLabel": "35元/小时",
    "unitPrice": 35.0,
    "hours": 2.5
  },
  {
    "key": "fastCut",
    "name": "快速切割",
    "unitPriceLabel": "12元/小时",
    "unitPrice": 12.0,
    "hours": 1.0
  }
]
```

**字段说明**：

- `key` (string): 加工类型唯一标识
- `name` (string): 加工形工/工种名称
- `unitPriceLabel` (string): 含税单价标签（如"35元/小时"）
- `unitPrice` (number): 含税单价（元/小时），保留2位小数
- `hours` (number): 用时（小时），保留1位小数

**计算字段**：

- `合计费用` = `unitPrice × hours`（可在前端或后端计算）

---

## 字段映射关系

### 前端表单字段 → 数据库字段映射

#### 基本信息字段

- `quotationNo` → `报价单号`
- `quotationDate` → `报价日期`
- `customerName` → `客户名称`
- `processingDate` → `加工周期`
- `changeOrderNo` → `更改通知单号`
- `partName` → `加工零件名称`
- `moldNo` → `模具编号`
- `department` → `申请更改部门`
- `applicant` → `申请更改人`
- `otherFee` → `其他费用`
- `transportFee` → `运输费用`
- `quantity` → `加工数量`
- `含税价格` = `materialsTotal + processingTotal + otherFee + transportFee`（计算字段）

#### 材料明细字段映射

- `materials` (数组) → `材料明细` (JSON字符串)
  - `materials[].name` → JSON中的 `name`
  - `materials[].unitPrice` → JSON中的 `unitPrice`
  - `materials[].quantity` → JSON中的 `quantity`

#### 加工费用明细字段映射

- `processes` (数组) → `加工费用明细` (JSON字符串)
  - `processes[].key` → JSON中的 `key`
  - `processes[].name` → JSON中的 `name`
  - `processes[].unitPriceLabel` → JSON中的 `unitPriceLabel`
  - `processes[].unitPrice` → JSON中的 `unitPrice`
  - `processes[].hours` → JSON中的 `hours`

---

## 数据操作示例

### 插入数据示例

```sql
INSERT INTO 报价单 (
    报价单号, 报价日期, 客户名称, 加工周期, 更改通知单号,
    加工零件名称, 模具编号, 申请更改部门, 申请更改人,
    材料明细, 加工费用明细, 其他费用, 运输费用, 加工数量, 含税价格
) VALUES (
    'BJ-20251204-001',
    '2025-12-04',
    '长虹美菱股份有限公司',
    '2025-12-10',
    'CG-2025-001',
    '零件A',
    'MJ-001',
    '技术部',
    '张三',
    '[{"name":"紫铜电极","unitPrice":100.00,"quantity":2},{"name":"配件","unitPrice":50.00,"quantity":1}]',
    '[{"key":"nc","name":"数控","unitPriceLabel":"35元/小时","unitPrice":35.00,"hours":2.5},{"key":"fastCut","name":"快速切割","unitPriceLabel":"12元/小时","unitPrice":12.00,"hours":1.0}]',
    500.00,
    300.00,
    1,
    1000.00
);
```

### 查询数据示例（SQL Server 2016+ 支持JSON）

```sql
-- 查询报价单基本信息
SELECT
    报价单ID,
    报价单号,
    报价日期,
    客户名称,
    加工周期,
    加工零件名称,
    模具编号,
    其他费用,
    运输费用,
    加工数量,
    含税价格
FROM 报价单
WHERE 报价单号 = 'BJ-20251204-001';

-- 查询并解析材料明细（SQL Server 2016+）
SELECT
    报价单ID,
    报价单号,
    材料明细,
    JSON_VALUE(材料明细, '$[0].name') AS 第一个材料名称,
    JSON_QUERY(材料明细, '$') AS 材料明细JSON
FROM 报价单
WHERE 报价单ID = 1;

-- 查询并解析加工费用明细（SQL Server 2016+）
SELECT
    报价单ID,
    报价单号,
    加工费用明细,
    JSON_VALUE(加工费用明细, '$[0].name') AS 第一个加工类型,
    JSON_QUERY(加工费用明细, '$') AS 加工费用明细JSON
FROM 报价单
WHERE 报价单ID = 1;
```

---

## 注意事项

1. **JSON存储**：
   - 使用 `NVARCHAR(MAX)` 存储JSON字符串
   - SQL Server 2016+ 支持JSON函数（`JSON_VALUE`, `JSON_QUERY`等），可以查询和解析JSON数据
   - 如果使用旧版本SQL Server，需要在应用层（Node.js）解析JSON

2. **数据完整性**：
   - JSON字符串必须符合JSON格式规范
   - 建议在应用层进行JSON格式验证
   - 可以使用SQL Server的 `ISJSON()` 函数验证JSON格式

3. **计算字段**：
   - `费用`（材料明细）= `单价 × 用量`
   - `合计费用`（加工费用明细）= `含税单价 × 用时小时`
   - `含税价格`（主表）= `材料费总和 + 加工费总和 + 其他费用 + 运输费用`

   这些计算字段可以在插入/更新时计算并存储，也可以不存储，在查询时计算。

4. **默认值**：
   - 数值字段默认值为 0
   - 加工数量默认值为 1
   - 创建时间和更新时间默认值为当前时间
   - 材料明细和加工费用明细默认值为空数组JSON：`[]`

5. **唯一性约束**：报价单号设置为唯一索引，确保不会重复。

6. **索引优化**：
   - 主表按常用查询字段（报价日期、客户名称、加工周期）创建索引
   - JSON字段不支持直接索引，如需按JSON内容查询，建议在应用层处理

7. **性能考虑**：
   - JSON字段较大，查询时避免频繁解析
   - 如需按材料名称或加工类型查询，建议在应用层处理
   - 可以考虑添加计算列（Computed Column）存储常用查询字段

8. **数据迁移**：
   - 如果从多表设计迁移到单表设计，需要将明细表数据合并为JSON格式
   - 迁移脚本需要将多行明细数据转换为JSON数组
